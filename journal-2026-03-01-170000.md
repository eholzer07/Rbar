# Session Journal — 2026-03-01

## Chunk 13 — Admin Panel

### Scope
- Middleware: /admin requires ADMIN role
- Admin layout with sidebar nav
- /admin — overview stats
- /admin/recommendations — approve/reject venue recommendations (geocode + create venue on approve)
- /admin/claims — approve/reject venue owner claims
- /admin/venues — list + toggle status + edit link
- /admin/venues/new — add venue
- /admin/venues/[id]/edit — edit venue
- /admin/users — list + delete + make admin
- /admin/reviews — list + delete

### Deferred
- Sports data management (CLI-based sync, expose via API later)
- Venue merge duplicates (complex geospatial logic)
- User suspend (needs schema change)
- Feedback queue (Chunk 14)

### Work Log

### Completed

1. **src/middleware.ts** — Added `/admin` prefix check before protected paths. If unauthenticated → redirect `/signin`; if not ADMIN → redirect `/`. Other routes unaffected.
2. **src/app/admin/layout.tsx** — Admin shell with sidebar nav (Overview, Recommendations, Claims, Venues, Users, Reviews). Defense-in-depth role check (redirect `/` if not ADMIN). Full-height split layout.
3. **src/app/admin/page.tsx** — Stats grid: total users, active venues, pending recs (amber alert card), pending claims (amber alert card), check-ins last 7d, total watch events, total reviews.
4. **src/app/admin/recommendations/actions.ts** — `approveRecommendationAction`: geocodes via `geocodeAddress()`, generates unique slug, creates Venue, marks rec APPROVED. `rejectRecommendationAction`: optional reason. Fixed TS error: removed `location: undefined` (Unsupported type can't appear in create data).
5. **src/app/admin/recommendations/page.tsx** — Pending queue. Error banner for geocode failure (`?error=geocode&rec=ID`). Shows name, address, phone, website, description, teams, submitter, date.
6. **src/app/admin/claims/actions.ts** — `approveClaimAction`: `$transaction` updating venue.ownerId + claim status. `rejectClaimAction`: optional reason.
7. **src/app/admin/claims/page.tsx** — Pending queue. Warning if venue already has owner. Shows claimant name/email, message, date. Inline reject reason input.
8. **src/app/admin/venues/actions.ts** — `toggleVenueStatusAction`: ACTIVE ↔ INACTIVE.
9. **src/app/admin/venues/page.tsx** — Table with search (name/city), status badge, watchEvents/reviews counts, Edit link, Toggle button.
10. **src/app/admin/venues/new/actions.ts** — `createVenueAction`: validates required fields, geocodes, generates unique slug, creates venue, redirects to `/admin/venues`.
11. **src/app/admin/venues/new/page.tsx** — Form: name, address, city, state, zip, phone, website, description, status select.
12. **src/app/admin/venues/[id]/edit/actions.ts** — `updateVenueAction`: bound with venueId, updates all fields, optionally re-geocodes if checkbox checked.
13. **src/app/admin/venues/[id]/edit/page.tsx** — Edit form pre-filled from DB. "Re-geocode address" checkbox.
14. **src/app/admin/users/actions.ts** — `makeAdminAction`, `removeAdminAction`, `deleteUserAction`. All guard against self-modification.
15. **src/app/admin/users/page.tsx** — Table with search, role badge, reviews/events counts, joined date. Make Admin / Remove Admin / Delete buttons.
16. **src/app/admin/reviews/actions.ts** — `deleteReviewAction`.
17. **src/app/admin/reviews/page.tsx** — Table with search (venue name / user email), overall rating, truncated comment, date, delete button.

### Validation
- `tsc --noEmit` → 0 errors ✅
- `npm run lint` → 0 errors, 11 warnings (all intentional `_formData` params) ✅

### Shipped
- Committed as `6edcc9e` and pushed to `origin/main` (github.com/eholzer07/Rbar)

---

## Chunk 14 — In-App Product Feedback

### Scope
- `Feedback` model (FeedbackType enum, FeedbackStatus enum)
- `/feedback` — authenticated form with rate limit (5/user/24h)
- Floating `?` button in root layout (visible to logged-in users only)
- `/admin/feedback` — queue with status filter tabs + inline status update + delete
- Admin overview: open feedback count card
- Deferred: screenshot upload (needs file storage), email notifications (Chunk 5a)

### Completed

1. **prisma/schema.prisma** — Added `FeedbackType` (BUG_REPORT, FEATURE_REQUEST, GENERAL), `FeedbackStatus` (OPEN, IN_PROGRESS, RESOLVED, WONT_FIX), `Feedback` model with userId (nullable, SetNull on delete), type, title, body, status, createdAt/updatedAt. Added `feedbacks Feedback[]` to User.
2. **prisma/migrations/20260301000002_add_feedback/migration.sql** — Manual migration. Run `npx prisma migrate deploy` locally after `docker compose up -d`.
3. **`npx prisma generate`** — Client regenerated with Feedback model.
4. **src/middleware.ts** — `/feedback` added to protected paths.
5. **src/app/feedback/actions.ts** — `submitFeedbackAction`: validates type/title/body, rate-limits (5 per 24h via count query), creates Feedback, redirects with `?success=1`.
6. **src/app/feedback/page.tsx** — Form: type select (Bug/Feature/General), title input, body textarea. Success, missing-fields, and rate-limit banners. Form hidden after successful submit.
7. **src/components/feedback-button.tsx** — Async server component. Checks session; returns null if unauthenticated. Renders fixed bottom-right `?` link to `/feedback`.
8. **src/app/layout.tsx** — Imported and rendered `<FeedbackButton />` inside body (outside Providers, fixed-positioned).
9. **src/app/admin/feedback/actions.ts** — `updateFeedbackStatusAction` (bound with feedbackId, reads status from formData, validates, updates). `deleteFeedbackAction`.
10. **src/app/admin/feedback/page.tsx** — List with status filter tabs. Each item shows type badge, status badge, title, body, submitter, date. Inline status select + update button. Delete button.
11. **src/app/admin/layout.tsx** — "Feedback" link added to sidebar nav.
12. **src/app/admin/page.tsx** — Added `openFeedback` count to Promise.all; added "Open Feedback" stat card with amber alert when > 0.

### Validation
- `tsc --noEmit` → 0 errors ✅
- `npm run lint` → 0 errors, 12 warnings (all intentional `_formData` params) ✅

### Shipped
- Committed as `0ef34cd` and pushed to `origin/main` (github.com/eholzer07/Rbar)
